<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‰å­—ä¹¦å†™ç»ƒä¹ ï¼ˆåœ£è¯æœ€ç»ˆä¿®å¤ç‰ˆï¼‰</title>
    <style>
        :root {
            --color-bg: #f0f4f8;
            --color-red: #D42426;
            --color-green: #146B3A;
            --color-gold: #F8B229;
            --color-text: #2c3e50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'SimSun', serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            overflow-x: hidden;
            /* é˜²æ­¢æ‰‹æœºç«¯ä¸‹æ‹‰åˆ·æ–°å½±å“å†™å­— */
            overscroll-behavior: none; 
        }

        /* --- 1. ç‰¹æ•ˆå±‚ (z-index: 1) --- 
           æ”¾åœ¨æœ€åº•å±‚ï¼Œç»å¯¹ä¸ä¼šæŒ¡ä½æŒ‰é’® */
        #effectsLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
            overflow: hidden;
        }
        .snowflake { position: absolute; top: -20px; color: #b0d4f1; animation: fall linear infinite; }
        .firework { position: absolute; width: 6px; height: 6px; border-radius: 50%; animation: explode 1s ease-out forwards; }
        @keyframes fall { to { transform: translateY(110vh); } }
        @keyframes explode { to { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* --- 2. ä¸»ç•Œé¢å±‚ (z-index: 10) --- 
           æ”¾åœ¨ä¸Šå±‚ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆ */
        .container {
            position: relative; z-index: 10;
            max-width: 1600px; margin: 0 auto; display: flex; gap: 15px; height: 100vh; padding: 15px;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 240px; background: #fff; border-radius: 12px; padding: 15px;
            border: 2px solid var(--color-green);
            display: flex; flex-direction: column; overflow-y: auto;
        }
        .sidebar h2 { color: var(--color-green); text-align: center; border-bottom: 2px dashed var(--color-gold); padding-bottom: 5px; margin-bottom: 10px; }
        .left-sidebar { order: 1; } .right-sidebar { order: 3; }

        /* ä¸­é—´åŒºåŸŸ */
        .main-content {
            flex: 1; order: 2; display: flex; flex-direction: column; height: 100%;
            background: rgba(255, 255, 255, 0.85); /* åŠé€æ˜èƒŒæ™¯ï¼Œé€å‡ºçƒŸèŠ± */
            border-radius: 12px; border: 3px solid var(--color-red);
            backdrop-filter: blur(5px);
        }

        header { text-align: center; padding: 10px; border-bottom: 2px solid var(--color-green); }
        h1 { color: var(--color-red); font-size: 1.5rem; text-shadow: 1px 1px 0 #fff; }
        .sub-title { color: var(--color-green); font-size: 0.9rem; margin-top: 5px; }

        .board-container { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        
        /* æ¡Œé¢æ ¼å­å¸ƒå±€ */
        .desktop-grid-wrapper { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; 
            width: 100%; max-width: 600px; 
        }

        /* æ ¼å­æ ·å¼ */
        .grid-box {
            position: relative; width: 100%; aspect-ratio: 1;
            background: #fff; border: 1px solid var(--color-green); border-radius: 4px;
            cursor: crosshair;
        }
        .grid-box.active {
            box-shadow: 0 0 0 3px var(--color-gold); border-color: var(--color-gold);
        }
        
        /* ç±³å­—æ ¼çº¿ */
        .line { position: absolute; background: rgba(248, 178, 41, 0.4); pointer-events: none; }
        .line-h { top: 50%; left: 0; width: 100%; height: 1px; }
        .line-v { left: 50%; top: 0; width: 1px; height: 100%; }
        .line-d1 { top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top right, transparent 49.5%, rgba(248, 178, 41, 0.4) 50%, transparent 50.5%); }
        .line-d2 { top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top left, transparent 49.5%, rgba(248, 178, 41, 0.4) 50%, transparent 50.5%); }

        /* ç”»å¸ƒ - å¿…é¡» touch-action: none é˜²æ­¢æ»šåŠ¨ */
        canvas.drawing-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; touch-action: none;
        }

        /* è£…é¥°è§’æ ‡ */
        .corner-deco { position: absolute; font-size: 16px; z-index: 5; pointer-events: none; }
        .tl { top: 2px; left: 2px; } .tr { top: 2px; right: 2px; }

        /* UI å…ƒç´  */
        .status-box { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; text-align: center; }
        .color-row { display: flex; justify-content: center; gap: 5px; margin-top: 5px; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ccc; }
        .color-dot.active { transform: scale(1.3); border: 2px solid var(--color-gold); }

        .btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 8px;
            border: none; border-radius: 6px; font-weight: bold; color: #fff; cursor: pointer;
            font-size: 14px; position: relative; z-index: 100; /* ç¡®ä¿æŒ‰é’®å¯ç‚¹ */
        }
        .btn:active { transform: translateY(2px); }
        .btn-red { background: var(--color-red); }
        .btn-green { background: var(--color-green); }
        .btn-gold { background: var(--color-gold); color: #8b4513; }
        .btn-blue { background: #3498db; }

        .input-group { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .input-group input { width: 50px; text-align: center; border: 1px solid var(--color-green); border-radius: 4px; }

        /* å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; text-align: center; border: 4px solid var(--color-red);
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--color-red); }

        /* æ‰‹æœºç«¯å¸ƒå±€ */
        .mobile-view { display: none; width: 100%; flex-direction: column; }
        .mobile-preview { display: flex; overflow-x: auto; gap: 10px; padding: 10px; background: #fff; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
        .mobile-preview-item { flex-shrink: 0; width: 60px; height: 60px; border: 1px solid #ccc; position: relative; }
        .mobile-preview-item.active { border-color: var(--color-red); box-shadow: 0 0 0 2px var(--color-red); }
        
        .mobile-canvas-area { width: 300px; height: 300px; margin: 0 auto 15px; position: relative; border: 4px solid var(--color-red); background: #fff; }
        
        @media (max-width: 1000px) {
            .sidebar, .desktop-board-container { display: none !important; }
            .container { flex-direction: column; padding: 5px; height: auto; min-height: 100vh; }
            .main-content { padding-bottom: 20px; }
            .mobile-view { display: flex; }
            .mobile-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 15px; }
            .mobile-controls .btn:last-child { grid-column: span 2; }
        }
    </style>
</head>
<body>

<div id="effectsLayer"></div>

<div class="container">
    <div class="sidebar left-sidebar">
        <h2>çŠ¶æ€ | Status</h2>
        <div class="status-box">
            <div>é¢œè‰²é¡ºåº</div>
            <div class="color-row" id="colorSeqDesktop"></div>
        </div>
        <div class="status-box">
            <div>å½“å‰: <span id="curIdx">1</span></div>
            <div>ç¬”ç”»: <span id="strokeCount">0</span></div>
        </div>
    </div>

    <div class="main-content">
        <header>
            <h1>æ±‰å­—ä¹¦å†™ç»ƒä¹ ï¼ˆåœ£è¯ç‰ˆï¼‰</h1>
            <span class="sub-title">Ğ”ÑŠÑĞºĞ° Ğ·Ğ° Ğ¿Ğ¸ÑĞ°Ğ½Ğµ Ğ½Ğ° ĞºĞ¸Ñ‚Ğ°Ğ¹ÑĞºĞ¸ Ğ¹ĞµÑ€Ğ¾Ğ³Ğ»Ğ¸Ñ„Ğ¸</span>
        </header>

        <div class="desktop-board-container board-container">
            <div class="desktop-grid-wrapper" id="desktopGridWrapper"></div>
        </div>

        <div class="mobile-view">
            <div class="mobile-preview" id="mobilePreviewBar"></div>
            
            <div class="mobile-canvas-area" id="mobileCanvasContainer">
                </div>

            <div class="input-group" style="margin-top:10px;">
                <span style="line-height:30px;">æ·»åŠ æ ¼å­:</span>
                <input type="number" id="mobileAddCount" value="9">
                <button class="btn btn-red" style="width:auto;" onclick="addGrids(true)">+</button>
            </div>

            <div class="mobile-controls">
                <button class="btn btn-green" onclick="prevGrid()">ä¸Šä¸€æ ¼</button>
                <button class="btn btn-green" onclick="nextGrid()">ä¸‹ä¸€æ ¼</button>
                <button class="btn btn-gold" onclick="undo()">æ’¤é”€</button>
                <button class="btn btn-red" onclick="clearGrid()">æ¸…ç©ºå½“å‰</button>
                <button class="btn btn-blue" onclick="exportImg()">å¯¼å‡ºå›¾ç‰‡</button>
                <button class="btn btn-gold" onclick="showOverview()">æ•´ä½“é¢„è§ˆ</button>
            </div>
        </div>
    </div>

    <div class="sidebar right-sidebar">
        <h2>å·¥å…· | Tools</h2>
        <div class="input-group">
            <input type="number" id="pcAddCount" value="9">
            <button class="btn btn-red" style="width:auto;" onclick="addGrids(false)">æ·»åŠ æ ¼å­</button>
        </div>
        <button class="btn btn-gold" onclick="undo()">æ’¤é”€ä¸Šä¸€ç¬”</button>
        <button class="btn btn-red" onclick="clearGrid()">æ¸…ç©ºæ‰€é€‰</button>
        <button class="btn btn-red" onclick="resetAll()">æ¸…ç©ºæ‰€æœ‰</button>
        <button class="btn btn-blue" onclick="exportImg()">å¯¼å‡ºå›¾ç‰‡</button>
        <button class="btn btn-gold" onclick="showOverview()">æ•´ä½“é¢„è§ˆ</button>
    </div>
</div>

<div class="modal" id="exportModal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('exportModal').style.display='none'">&times;</span>
        <h3 style="color:#D42426; margin-bottom:10px;">å¯¼å‡ºå›¾ç‰‡</h3>
        <input type="text" id="exportName" placeholder="è¾“å…¥å§“å" style="padding:8px; border:1px solid #ccc; border-radius:4px; margin-bottom:10px;">
        <button class="btn btn-green" onclick="generateImage()" style="width:50%; margin:0 auto;">ç”Ÿæˆè´ºå¡</button>
        <div id="imgPreview" style="margin-top:15px;"></div>
    </div>
</div>

<div class="modal" id="overviewModal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('overviewModal').style.display='none'">&times;</span>
        <h3>æ•´ä½“é¢„è§ˆ</h3>
        <div id="overviewList" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const COLORS = [
        { s: '#D42426', e: '#FFCCCC' }, // çº¢
        { s: '#F8B229', e: '#FFF8E0' }, // é‡‘
        { s: '#146B3A', e: '#D0F0D0' }, // ç»¿
        { s: '#1E90FF', e: '#D0E8FF' }, // è“
        { s: '#800080', e: '#E6CCFF' }  // ç´«
    ];
    
    let state = {
        total: 9,
        current: 0,
        strokes: {}, // { 0: [{points:[], colorIdx:0}] }
        colorState: {} // { 0: 2 }
    };

    const SIZE = 300; // ç”»å¸ƒé€»è¾‘å¤§å°

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        initEffects();
        initUI();
        render();
    };

    // --- æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ---
    function render() {
        renderDesktop();
        renderMobile();
        updateStatus();
    }

    function renderDesktop() {
        const wrap = document.getElementById('desktopGridWrapper');
        wrap.innerHTML = '';
        for(let i=0; i<state.total; i++) {
            const div = document.createElement('div');
            div.className = `grid-box ${i === state.current ? 'active' : ''}`;
            div.onclick = () => { state.current = i; render(); };
            
            // èƒŒæ™¯ç»“æ„
            div.innerHTML = `
                <div class="line line-h"></div><div class="line line-v"></div>
                <div class="line line-d1"></div><div class="line line-d2"></div>
                <div class="corner-deco tl">ğŸ’</div><div class="corner-deco tr">ğŸ’</div>
                <div style="position:absolute; bottom:2px; right:5px; font-size:12px; color:#146B3A; font-weight:bold;">${i+1}</div>
            `;
            
            // ç”»å¸ƒ
            const cvs = document.createElement('canvas');
            cvs.className = 'drawing-layer';
            cvs.width = SIZE; cvs.height = SIZE;
            setupCanvas(cvs, i);
            drawStrokes(cvs, i);
            
            div.appendChild(cvs);
            wrap.appendChild(div);
        }
    }

    function renderMobile() {
        const container = document.getElementById('mobileCanvasContainer');
        container.innerHTML = '';
        
        // å½“å‰å¤§æ ¼å­
        const div = document.createElement('div');
        div.style.position = 'relative'; div.style.width='100%'; div.style.height='100%';
        div.innerHTML = `
            <div class="line line-h"></div><div class="line line-v"></div>
            <div class="line line-d1"></div><div class="line line-d2"></div>
            <div class="corner-deco tl">ğŸ’</div><div class="corner-deco tr">ğŸ’</div>
        `;
        const cvs = document.createElement('canvas');
        cvs.className = 'drawing-layer';
        cvs.width = SIZE; cvs.height = SIZE;
        setupCanvas(cvs, state.current);
        drawStrokes(cvs, state.current);
        
        div.appendChild(cvs);
        container.appendChild(div);

        // é¢„è§ˆæ¡
        const bar = document.getElementById('mobilePreviewBar');
        bar.innerHTML = '';
        for(let i=0; i<state.total; i++) {
            const item = document.createElement('div');
            item.className = `mobile-preview-item ${i===state.current?'active':''}`;
            item.onclick = () => { state.current = i; render(); };
            
            const pCvs = document.createElement('canvas');
            pCvs.width = 60; pCvs.height = 60;
            pCvs.style.width='100%'; pCvs.style.height='100%';
            drawStrokes(pCvs, i, 60/SIZE); // ç¼©æ”¾ç»˜åˆ¶
            
            item.appendChild(pCvs);
            // åºå·
            const num = document.createElement('div');
            num.innerText = i+1;
            num.style.position='absolute'; num.style.bottom='0'; num.style.right='2px'; num.style.fontSize='10px';
            item.appendChild(num);
            
            bar.appendChild(item);
        }
    }

    // --- ç”»å¸ƒäº‹ä»¶å¤„ç† (ä¿®å¤åç§»å’Œæ»šåŠ¨) ---
    function setupCanvas(cvs, idx) {
        const ctx = cvs.getContext('2d');
        let isDown = false;
        let points = [];

        // ç»Ÿä¸€åæ ‡è·å–
        const getPoint = (e) => {
            const rect = cvs.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (cvs.width / rect.width),
                y: (clientY - rect.top) * (cvs.height / rect.height)
            };
        };

        const start = (e) => {
            if(e.cancelable) e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
            isDown = true;
            points = [getPoint(e)];
            spawnFirework(e.touches ? e.touches[0].clientX : e.clientX, e.touches ? e.touches[0].clientY : e.clientY);
        };

        const move = (e) => {
            if(!isDown) return;
            if(e.cancelable) e.preventDefault();
            const p = getPoint(e);
            points.push(p);
            
            // å®æ—¶ç»˜åˆ¶
            const cIdx = state.colorState[idx] || 0;
            ctx.beginPath();
            if(points.length > 1) {
                ctx.moveTo(points[points.length-2].x, points[points.length-2].y);
                ctx.lineTo(p.x, p.y);
            } else {
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y);
            }
            ctx.strokeStyle = COLORS[cIdx % 5].s;
            ctx.lineWidth = 12;
            ctx.lineCap = 'round';
            ctx.stroke();
        };

        const end = () => {
            if(!isDown) return;
            isDown = false;
            if(points.length > 1) {
                if(!state.strokes[idx]) state.strokes[idx] = [];
                const cIdx = state.colorState[idx] || 0;
                state.strokes[idx].push({
                    points: [...points],
                    colorIdx: cIdx % 5
                });
                state.colorState[idx] = (cIdx + 1);
                // ä»…é‡ç»˜ï¼Œä¸éœ€å®Œå…¨render
                render(); 
            }
        };

        cvs.addEventListener('mousedown', start);
        cvs.addEventListener('mousemove', move);
        cvs.addEventListener('mouseup', end);
        cvs.addEventListener('mouseleave', end);
        
        cvs.addEventListener('touchstart', start, {passive: false});
        cvs.addEventListener('touchmove', move, {passive: false});
        cvs.addEventListener('touchend', end);
    }

    // --- ç»˜åˆ¶ç¬”ç”» (æ”¯æŒæ¸å˜) ---
    function drawStrokes(cvs, idx, scale = 1) {
        const ctx = cvs.getContext('2d');
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        const strokes = state.strokes[idx] || [];
        strokes.forEach(stroke => {
            const pts = stroke.points;
            if(pts.length < 2) return;
            
            const color = COLORS[stroke.colorIdx];
            const c1 = hexToRgb(color.s);
            const c2 = hexToRgb(color.e);
            
            ctx.lineWidth = 12 * scale;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const len = pts.length - 1;
            for(let i=0; i<len; i++) {
                const t = i / len;
                const r = Math.round(c1.r + (c2.r - c1.r) * t);
                const g = Math.round(c1.g + (c2.g - c1.g) * t);
                const b = Math.round(c1.b + (c2.b - c1.b) * t);
                
                ctx.beginPath();
                ctx.strokeStyle = `rgb(${r},${g},${b})`;
                ctx.moveTo(pts[i].x * scale, pts[i].y * scale);
                ctx.lineTo(pts[i+1].x * scale, pts[i+1].y * scale);
                ctx.stroke();
            }
        });
    }

    // --- é€»è¾‘åŠŸèƒ½ ---
    function addGrids(isMobile) {
        const id = isMobile ? 'mobileAddCount' : 'pcAddCount';
        const val = parseInt(document.getElementById(id).value) || 1;
        state.total += val;
        render();
        spawnFirework(window.innerWidth/2, window.innerHeight/2);
    }
    
    function undo() {
        const s = state.strokes[state.current];
        if(s && s.length) {
            s.pop();
            if(state.colorState[state.current] > 0) state.colorState[state.current]--;
            render();
        }
    }
    
    function clearGrid() {
        if(confirm('æ¸…ç©ºå½“å‰æ ¼å­ï¼Ÿ')) {
            state.strokes[state.current] = [];
            state.colorState[state.current] = 0;
            render();
        }
    }
    
    function resetAll() {
        if(confirm('æ¸…ç©ºæ‰€æœ‰å†…å®¹ï¼Ÿ')) {
            state.strokes = {};
            state.colorState = {};
            state.current = 0;
            render();
        }
    }
    
    function nextGrid() {
        if(state.current < state.total - 1) { state.current++; render(); }
    }
    
    function prevGrid() {
        if(state.current > 0) { state.current--; render(); }
    }

    function updateStatus() {
        document.getElementById('curIdx').innerText = state.current + 1;
        document.getElementById('strokeCount').innerText = (state.strokes[state.current]||[]).length;
        
        // æ›´æ–°é¢œè‰²ç‚¹
        const cSeq = document.getElementById('colorSeqDesktop');
        cSeq.innerHTML = '';
        COLORS.forEach((c, i) => {
            const d = document.createElement('div');
            d.className = 'color-dot';
            d.style.background = c.s;
            const nextColorIndex = (state.colorState[state.current] || 0) % 5;
            if(i === nextColorIndex) d.className += ' active';
            cSeq.appendChild(d);
        });
    }

    function initUI() {
        document.getElementById('totalGridNum').innerText = state.total;
        document.getElementById('totalGridNumMobile').innerText = state.total;
    }

    // --- ç‰¹æ•ˆé€»è¾‘ ---
    function initEffects() {
        // é›ªèŠ±
        const snow = document.getElementById('snowContainer');
        for(let i=0; i<30; i++) {
            const s = document.createElement('div');
            s.className = 'snowflake'; s.innerText = 'â„';
            s.style.left = Math.random()*100 + '%';
            s.style.animationDuration = (Math.random()*5+5) + 's';
            s.style.fontSize = (Math.random()*10+10) + 'px';
            snow.appendChild(s);
        }
        
        // è‡ªåŠ¨çƒŸèŠ±
        setInterval(() => {
            if(Math.random() > 0.7) spawnFirework(Math.random()*window.innerWidth, Math.random()*window.innerHeight);
        }, 1500);
    }

    function spawnFirework(x, y) {
        const c = document.getElementById('effectsLayer');
        const colors = ['#D42426', '#F8B229', '#146B3A', '#1E90FF'];
        for(let i=0; i<10; i++) {
            const p = document.createElement('div');
            p.className = 'firework';
            p.style.left = x + 'px'; p.style.top = y + 'px';
            p.style.background = colors[Math.floor(Math.random()*colors.length)];
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * 100 + 50;
            p.style.setProperty('--tx', Math.cos(angle)*dist + 'px');
            p.style.setProperty('--ty', Math.sin(angle)*dist + 'px');
            c.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }
    }

    // --- å¯¼å‡ºé€»è¾‘ (å¸¦ç« å’Œå†¬é’) ---
    function exportImg() {
        document.getElementById('exportModal').style.display = 'flex';
        document.getElementById('imgPreview').innerHTML = 'ç”Ÿæˆä¸­...';
    }

    function generateImage() {
        const name = document.getElementById('exportName').value;
        const cols = 3;
        const rows = Math.ceil(state.total / 3);
        const gap = 10;
        const size = 150; // å¯¼å‡ºé«˜æ¸…åŸºå‡†
        const padding = 40;
        const headerH = 60;
        const footerH = 100; // ç•™å‡ºå°ç« ç©ºé—´
        
        const cvs = document.createElement('canvas');
        const W = padding*2 + cols*size + (cols-1)*gap;
        const H = padding*2 + headerH + footerH + rows*(size+gap);
        
        cvs.width = W * 2; cvs.height = H * 2; // 2å€é«˜æ¸…
        const ctx = cvs.getContext('2d');
        ctx.scale(2, 2);
        
        // èƒŒæ™¯
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, W, H);
        
        // é™æ€é›ªèŠ±èƒŒæ™¯
        ctx.fillStyle = 'rgba(176, 212, 241, 0.4)';
        for(let i=0; i<50; i++) {
            ctx.font = Math.random()*20+10 + 'px serif';
            ctx.fillText('â„', Math.random()*W, Math.random()*H);
        }

        // è¾¹æ¡†
        ctx.strokeStyle = '#D42426'; ctx.lineWidth = 4;
        ctx.strokeRect(10, 10, W-20, H-20);
        ctx.strokeStyle = '#F8B229'; ctx.lineWidth = 2;
        ctx.strokeRect(16, 16, W-32, H-32);

        // æ ‡é¢˜ä¿¡æ¯
        ctx.fillStyle = '#146B3A'; ctx.font = 'bold 24px serif'; ctx.textAlign = 'left';
        ctx.fillText(`å§“å: ${name}`, padding, padding + 30);
        ctx.fillStyle = '#D42426'; ctx.font = '16px serif'; ctx.textAlign = 'right';
        const d = new Date();
        ctx.fillText(`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`, W - padding, padding + 30);

        // ç»˜åˆ¶æ ¼å­
        for(let i=0; i<state.total; i++) {
            const r = Math.floor(i / cols);
            const c = i % cols;
            const x = padding + c * (size + gap);
            const y = padding + headerH + r * (size + gap);
            
            // æ ¼å­æ¡†
            ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.fillRect(x, y, size, size);
            ctx.strokeStyle = '#146B3A'; ctx.lineWidth = 1; ctx.strokeRect(x, y, size, size);
            
            // ç±³å­—çº¿
            ctx.beginPath();
            ctx.moveTo(x, y+size/2); ctx.lineTo(x+size, y+size/2);
            ctx.moveTo(x+size/2, y); ctx.lineTo(x+size/2, y+size);
            ctx.moveTo(x, y); ctx.lineTo(x+size, y+size);
            ctx.moveTo(x+size, y); ctx.lineTo(x, y+size);
            ctx.strokeStyle = 'rgba(248, 178, 41, 0.3)'; ctx.lineWidth = 1; ctx.stroke();
            
            // è§’è½è£…é¥° (å·¦ä¸Š + å³ä¸Š)
            drawHolly(ctx, x+5, y+5, 0); // TL
            drawHolly(ctx, x+size-5, y+5, 1); // TR

            // ç¬”ç”»
            if(state.strokes[i]) {
                const sStrokes = state.strokes[i];
                const scale = size / SIZE;
                sStrokes.forEach(s => {
                    const pts = s.points.map(p => ({x: p.x*scale + x, y: p.y*scale + y}));
                    drawExportStroke(ctx, pts, s.colorIdx, 12 * scale);
                });
            }
        }

        // å°ç«  (å³ä¸‹è§’ç©ºç™½å¤„)
        drawSeal(ctx, W - 60, H - 60);

        const img = document.getElementById('exportImgResult');
        img.src = cvs.toDataURL();
        img.style.display = 'block';
    }

    function drawExportStroke(ctx, pts, cIdx, lw) {
        if(pts.length<2) return;
        const c1 = hexToRgb(COLORS[cIdx].s);
        const c2 = hexToRgb(COLORS[cIdx].e);
        ctx.lineWidth = lw; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        for(let i=0; i<pts.length-1; i++) {
            const t = i / (pts.length-1);
            const r = Math.round(c1.r + (c2.r-c1.r)*t);
            const g = Math.round(c1.g + (c2.g-c1.g)*t);
            const b = Math.round(c1.b + (c2.b-c1.b)*t);
            ctx.beginPath();
            ctx.strokeStyle = `rgb(${r},${g},${b})`;
            ctx.moveTo(pts[i].x, pts[i].y);
            ctx.lineTo(pts[i+1].x, pts[i+1].y);
            ctx.stroke();
        }
    }

    function drawHolly(ctx, x, y, type) {
        ctx.save(); ctx.translate(x, y);
        if(type === 1) ctx.scale(-1, 1);
        // å¶å­
        ctx.fillStyle = '#146B3A';
        ctx.beginPath(); ctx.ellipse(0, 0, 8, 4, Math.PI/4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(0, 0, 8, 4, -Math.PI/4, 0, Math.PI*2); ctx.fill();
        // æœå­
        ctx.fillStyle = '#D42426';
        ctx.beginPath(); ctx.arc(-2, -2, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(2, -2, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(0, 2, 3, 0, Math.PI*2); ctx.fill();
        // é“ƒé“›
        ctx.fillStyle = '#F8B229';
        ctx.beginPath(); ctx.arc(0, 8, 4, 0, Math.PI, true); ctx.lineTo(-4, 12); ctx.lineTo(4, 12); ctx.fill();
        ctx.restore();
    }

    function drawSeal(ctx, x, y) {
        const r = 40;
        ctx.save(); ctx.translate(x, y);
        
        // é•‚ç©ºå¤–åœˆ
        ctx.strokeStyle = '#D42426'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.arc(0, 0, r-3, 0, Math.PI*2); ctx.stroke();

        // é•‚ç©ºåœ£è¯è€äººçº¿æ¡
        ctx.beginPath();
        ctx.moveTo(-10, -5); ctx.lineTo(0, -20); ctx.lineTo(10, -5); // å¸½
        ctx.moveTo(-10, -5); ctx.quadraticCurveTo(0, 15, 10, -5); // è„¸
        ctx.moveTo(-8, 5); ctx.quadraticCurveTo(0, 20, 8, 5); // èƒ¡å­
        ctx.stroke();
        ctx.beginPath(); ctx.arc(-3, -2, 1, 0, Math.PI*2); ctx.stroke(); // çœ¼
        ctx.beginPath(); ctx.arc(3, -2, 1, 0, Math.PI*2); ctx.stroke(); 

        // å¼§å½¢æ–‡å­—
        ctx.fillStyle = '#D42426'; ctx.textAlign = 'center'; ctx.textBaseline='middle';
        ctx.font = 'bold 12px serif';
        
        // ä¸Šï¼šåœ£è¯å¿«ä¹
        const txt1 = "åœ£è¯å¿«ä¹";
        for(let i=0; i<txt1.length; i++) {
            ctx.save(); ctx.rotate(-0.5 + i*0.35);
            ctx.fillText(txt1[i], 0, -r+10); ctx.restore();
        }
        
        // ä¸‹ï¼šä¿åŠ åˆ©äºšè¯­
        ctx.font = 'bold 8px sans-serif';
        const txt2 = "Ğ’ĞµÑĞµĞ»Ğ° ĞšĞ¾Ğ»ĞµĞ´Ğ°";
        const step = 0.15;
        const start = -(txt2.length * step) / 2;
        for(let i=0; i<txt2.length; i++) {
            ctx.save(); ctx.rotate(start + i*step);
            ctx.fillText(txt2[i], 0, r-8); ctx.restore();
        }

        ctx.restore();
    }

    function hexToRgb(hex) { const b=parseInt(hex.slice(1),16); return {r:(b>>16)&255,g:(b>>8)&255,b:b&255}; }
    function showOverview() {
        const m = document.getElementById('overviewModal');
        const l = document.getElementById('overviewList');
        l.innerHTML = '';
        m.style.display = 'flex';
        // ç®€å•æ¸²æŸ“é¢„è§ˆ
        for(let i=0; i<state.total; i++) {
            const div = document.createElement('div');
            div.style.border = '1px solid #146B3A';
            div.style.background = '#fff';
            div.innerHTML = `<div style="text-align:center; color:#146B3A;">${i+1}</div>`;
            l.appendChild(div);
        }
    }
</script>
</body>
</html>
